<?php

/**
 * @file
 * Contains obiba_agate.module.
 * Agate authentication Drupal integration
 */

use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\core\Form\FormStateInterface;
use Drupal\Core\Link;

use Drupal\obiba_agate\ObibaAgate;


/**
 * Implements hook_help().
 */
function obiba_agate_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the mica_external_entities module.
    case 'help.page.obiba_mica':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Mica server data external entities Drupal integration') . '</p>';
      return $output;

    default:
  }
}


function obiba_agate_theme_suggestions_form_element_alter(array &$suggestions, array $variables) {
  if (\Drupal::service('path.current')->getPath() == '/user/login') {
    $suggestions[] = $variables['theme_hook_original'] . '--user-login';
  }
}

/**
 * Preprocess page title
 */
function obiba_agate_preprocess_page_title(&$variables) {
  if (strstr(\Drupal::service('path.current')->getPath(), 'user/login')) {
    $variables['title'] = \Drupal::config(ObibaAgate::AGATE_SERVER_SETTINGS)->get(ObibaAgate::CONFIG_PREFIX_PAGE .
        '.' . 'obiba_login_page_title');
  }
}

/**
 * Implements hook_form_user_login_form_alter().
 *
 * Adjusts form on login page.
 */
function obiba_agate_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id){
    $agate_page_config = \Drupal::config(ObibaAgate::AGATE_SERVER_SETTINGS);
    $form['#prefix'] = '<div class="row">
    <div class="col-md-4"></div>
    <div class="well col-md-4">';
    $form['#suffix'] = '</div>
    <div class="col-md-4"></div>
    </div>';
    $form['name']['#title'] = $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'obiba_login_username_label');
    $form['name']['#smart_description'] = $form['pass']['#smart_description'] =
        $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'enable_form_tooltips') ? TRUE : FALSE;

    $form['actions']['submit']['#value'] = $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'obiba_login_button_caption');
    $form['actions']['submit']['#attributes'] = [
        'class' => ['btn btn-primary'],
    ];

    if($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' .'access_signup_button_disabled')){
        unset($form['register']);
    }
    else{
        $form['register'] = [
            '#markup' => '<p class="register">' . Link::createFromRoute($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE .
                    '.' . 'access_signup_button')
                    , 'user.register')->toString() . '</p>',
            '#weight' => 101,
        ];
    }
    $form['reset'] = [
        '#markup' => '<p class="forgot-password">' . Link::createFromRoute($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE .
                '.' . 'obiba_reset_password_button_caption')
                , 'user.pass')->toString() . '</p>',
        '#weight' => 100,
    ];
}

/**
 * Implements hook_form_user_form_alter().
 *
 * Adjusts form on edit profile user page.
 */
function obiba_agate_form_alter(&$form, FormStateInterface $form_state, $form_id){
    if($form_id === '$form_id'){
        $form['account']['mail']['#disabled'] = TRUE;
    }
}

/**
 * Implements hook_form_user_register_form_alter().
 *
 * Adjusts form on register user page.
 */
function obiba_agate_form_user_register_form_alter(&$form, FormStateInterface $form_state, $form_id){
    $form['#prefix'] = '<div class="row">
    <div class="col-md-2"></div>
    <div class="well col-md-8">';
    $form['#suffix'] = '</div>
    <div class="col-md-2"></div>
    </div>';
    $formToreorder = $form['account'];
    unset($form['account']);
    $form['account']['#type'] = $formToreorder['#type'];
    $form['account']['#weight'] = $formToreorder['#weight'];

    $form['account']['name'] = $formToreorder['name'];
    $form['account']['mail'] = $formToreorder['mail'];
    $form['account']['pass'] = $formToreorder['pass'];
    $form['account']['pass']['#type'] = 'hidden';
    $form['account']['pass']['#required'] = false;
}


/**
 * Implements hook_local_tasks_alter().
 *
 * Removes tabs from login page.
 */
function obiba_agate_menu_local_tasks_alter(&$data, $route_name) {
  if ($route_name == 'user.login'){
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }
  if ($route_name == 'user.pass') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
    unset($data['tabs'][0]['user.login']);
  }
  if ($route_name == 'user.register') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }
}

/**
 * Implements hook_user_logou()
 *
 * @param $account
 */
function obiba_agate_user_logout($account){
    \Drupal::service('obiba_agate.server.agateclient')->logout();
}

/**
 * Implements hook_entity_presave().
 * useful to when update Drupal user
 */
function obiba_agate_user_presave(Drupal\Core\Entity\EntityInterface $entity){
        if(!empty($entity->original)){
            // Its an update
        }
        else{
            $server_response = \Drupal::service('obiba_agate.controller.agateusermanager')->createAgateUser($entity);
                if(!empty($server_response['code']) && $server_response['code'] !== 200){
                    $response = new RedirectResponse(\Drupal::request()->getRequestUri());
                    $response->send();
                    \Drupal::messenger()->addError($server_response['message']);
                    exit;
                }

        }
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function obiba_agate_user_insert(Drupal\Core\Entity\EntityInterface $entity) {
    if(!$entity->isAnonymous() && !empty($entity->field_agate_realm->getValue()[0])){
        \Drupal::service('obiba_agate.controller.agateusermanager')->externalAuth->linkExistingAccount($entity->name->getValue()[0]['value'], 'obiba_agate', $entity);
    }
}


