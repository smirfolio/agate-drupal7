<?php

/**
 * @file
 * Contains obiba_agate.module.
 * Agate authentication Drupal integration
 */

use Drupal\Core\Entity\EntityTypeManagerInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\core\Form\FormStateInterface;
use Drupal\Core\Link;

use Drupal\obiba_agate\ObibaAgate;
use Drupal\obiba_agate\Server\AgateClient;
use GuzzleHttp\ClientInterface;

/**
 * Implements hook_help().
 */
function obiba_agate_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the mica_external_entities module.
    case 'help.page.obiba_mica':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Mica server data external entities Drupal integration') . '</p>';
      return $output;

    default:
  }
}


function obiba_agate_theme_suggestions_form_element_alter(array &$suggestions, array $variables) {
  if (\Drupal::service('path.current')->getPath() == '/user/login') {
    $suggestions[] = $variables['theme_hook_original'] . '--user-login';
  }
}

/**
 * Preprocess page title
 */
function obiba_agate_preprocess_page_title(&$variables) {
  if (strstr(\Drupal::service('path.current')->getPath(), 'user/login')) {
    $variables['title'] = \Drupal::config(ObibaAgate::AGATE_SERVER_SETTINGS)->get(ObibaAgate::CONFIG_PREFIX_PAGE .
        '.' . 'obiba_login_page_title');
  }
}

/**
 * Implements hook_form_alter().
 *
 * Adjusts form on login page.
 */
function obiba_agate_form_alter(&$form, FormStateInterface $form_state, $form_id) {
    $agate_page_config = \Drupal::config(ObibaAgate::AGATE_SERVER_SETTINGS);
    if ($form_id == 'user_login_form') {
    $form['#prefix'] = '<div class="row">
    <div class="col-md-4"></div>
    <div class="well col-md-4">';
    $form['#suffix'] = '</div>
    <div class="col-md-4"></div>
    </div>';
    $form['name']['#title'] = $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'obiba_login_username_label');
    $form['name']['#smart_description'] = $form['pass']['#smart_description'] =
        $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'enable_form_tooltips') ? TRUE : FALSE;

    $form['actions']['submit']['#value'] = $agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' . 'obiba_login_button_caption');
    $form['actions']['submit']['#attributes'] = [
        'class' => ['btn btn-primary'],
    ];

    if($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE . '.' .'access_signup_button_disabled')){
        unset($form['register']);
    }
    else{
        $form['register'] = [
            '#markup' => '<p class="register">' . Link::createFromRoute($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE .
                    '.' . 'access_signup_button')
                        , 'user.register')->toString() . '</p>',
            '#weight' => 101,
        ];
    }
      $form['reset'] = [
          '#markup' => '<p class="forgot-password">' . Link::createFromRoute($agate_page_config->get(ObibaAgate::CONFIG_PREFIX_PAGE .
                  '.' . 'obiba_reset_password_button_caption')
                      , 'user.pass')->toString() . '</p>',
          '#weight' => 100,
      ];
  }
  if ($form_id == 'user_form'){
    $form['account']['mail']['#disabled'] = TRUE;
  }
}

/**
 * Implements hook_local_tasks_alter().
 *
 * Removes tabs from login page.
 */
function obiba_agate_menu_local_tasks_alter(&$data, $route_name) {
  if ($route_name == 'user.login'){
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }
  if ($route_name == 'user.pass') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
    unset($data['tabs'][0]['user.login']);
  }
  if ($route_name == 'user.register') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }
}

/**
 * Implements hook_user_logou()
 *
 * @param $account
 */
function obiba_agate_user_logout($account){
    \Drupal::service('obiba_agate.server.agateclient')->logout();
}

/**
 * Implements hook_entity_presave().
 * useful to when update Drupal user
 */
//function obiba_agate_entity_presave(Drupal\Core\Entity\EntityInterface $entity){
//    if($entity->bundle() == 'user'){
//        $config = \Drupal::config(ObibaAgate::AGATE_SERVER_SETTINGS);
//        $user_field_mapping = $config->get(ObibaAgate::CONFIG_PREFIX_USER_FIELDS_MAPPING);
//        $agate_user_profile = [];
//        foreach ($user_field_mapping[ObibaAgate::AGATE_PROFILE_FIELD] as $field => $agate_field){
//            if($user_field_mapping[ObibaAgate::DRUPAL_ENABLED_FILED_IMPORT][$field]){
//                $agate_user_profile[$field] = current($entity->{$user_field_mapping[ObibaAgate::DRUPAL_PROFILE_FIELD][$field]}->getValue()[0]);
//            }
//        }
//    }
//}
