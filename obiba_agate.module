<?php

/**
 * @file
 * Contains obiba_agate.module.
 * Agate authentication Drupal integration
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\core\Form\FormStateInterface;
use Drupal\Core\Link;

use Drupal\obiba_agate\obibaAgate;

/**
 * Implements hook_help().
 */
function obiba_agate_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the mica_external_entities module.
    case 'help.page.obiba_mica':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Mica server data external entities Drupal integration') . '</p>';
      return $output;

    default:
  }
}


//function obiba_agate_theme_suggestions_form_element_alter(array &$suggestions, array $variables) {
//  if (\Drupal::service('path.current')->getPath() == '/user/login') {
//    $suggestions[] = $variables['theme_hook_original'] . '--user-login';
//  }
//}

/**
 * Preprocess page title
 */
function obiba_agate_preprocess_page_title(&$variables) {
  if (strstr(\Drupal::service('path.current')->getPath(), 'user/login')) {
    $variables['title'] = \Drupal::config(obibaAgate::AGATE_SERVER_PAGES_SETTINGS)->get(obibaAgate::CONFIG_PREFIX_PAGE.'obiba_login_page_title');
  }
}

//access_signin_button

/**
 * Implements hook_form_alter().
 *
 * Adjusts form on login page.
 */
function obiba_agate_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $agate_page_config = \Drupal::config(obibaAgate::AGATE_SERVER_PAGES_SETTINGS);
  if ($form_id == 'user_login_form') {
    $form['#prefix'] = '<div class="row">
    <div class="col-md-4"></div>
    <div class="well col-md-4">';
    $form['#suffix'] = '</div> 
    <div class="col-md-4"></div>
    </div>';
    $form['name']['#title'] = $agate_page_config->get(obibaAgate::CONFIG_PREFIX_PAGE.'obiba_login_username_label');
    $form['reset'] = [
      '#markup' => '<p class="forgot-password">' . Link::createFromRoute(t('Rest password'), 'user.pass')->toString() . '</p>',
      '#weight' => 100,
    ];

    $form['register'] = [
      '#markup' => '<p class="register">' . Link::createFromRoute(t('register'), 'user.register')->toString() . '</p>',
      '#weight' => 101,
    ];
    $form['#validate'][] = '::validateName';
    $form['#validate'][] = '::validateAuthentication';
    $form['#validate'][] = 'obiba_agate_login_validate';
    $form['#validate'][] = '::validateFinal';
    $form['#validate'][] = '::validateForm';
  }
}

/**
 * The function callback to authenticate the user overriding drupal validation..
 *
 * The obiba_agate_auth() function attempts to authenticate a user off the
 * external system using their e-mail address.
 */

function obiba_agate_login_validate($form, &$form_state){
  $username = $form_state->getValue('name');
  $password = $form_state->getValue('pass');
  // Try to authenticate on Agate if not already Local Drupal User.
  if (!empty($username) && !empty($password) ) {
    $form_state->set('uid', 2);
//    if (obiba_agate_check_user($username, $password)) {
//      $account = obiba_agate_save_drupal_user();
//      $form_state['uid'] = $account->uid;
//      $_SESSION[ObibaAgateClient::AGATE_JUST_LOGGED_IN] = TRUE;
//    }
  }
  $toto = $form_state;
}

/**
 * Implements hook_local_tasks_alter().
 *
 * Removes tabs from login page.
 */
function obiba_agate_menu_local_tasks_alter(&$data, $route_name) {
  if ($route_name == 'user.login'){
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }
  if ($route_name == 'user.pass') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
    unset($data['tabs'][0]['user.login']);
  }
  if ($route_name == 'user.register') {
    unset($data['tabs'][0]['user.pass']);
    unset($data['tabs'][0]['user.register']);
  }

}
